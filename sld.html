<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HT Board SLD Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial, sans-serif;
  margin:0;
  background:#f2f6ff;
}

/* ===== HEADER ===== */
.header-bar{
  position:sticky;
  top:0;
  z-index:1000;
  background:#003f88;
  color:white;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px;
}

.header-bar button{
  background:white;
  color:#003f88;
  border:none;
  border-radius:6px;
  padding:8px 12px;
  font-size:16px;
  cursor:pointer;
}

.header-title{
  flex:1;
  text-align:center;
  font-size:22px;
  font-weight:700;
}

/* ===== CONTENT ===== */
.container{
  padding:15px;
}

.card{
  background:white;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  padding:20px;
}

/* ===== SLD AREA ===== */
#sldCanvas{
  width:100%;
  height:520px;
  background:#ffffff;
  border:1px solid #ccc;
}

/* ===== STATUS ===== */
.info{
  margin-bottom:10px;
  font-weight:bold;
  color:#003f88;
}

@media print{
  .header-bar{display:none;}
}
</style>
</head>

<body>

<!-- ===== HEADER ===== -->
<div class="header-bar">
  <button onclick="goHome()">üè† Home</button>
  <button onclick="goBack()">‚¨Ö Back</button>
  <div class="header-title" id="title">HT BOARD SLD</div>
</div>

<div class="container">
  <div class="card">

    <div class="info" id="boardInfo">Loading board...</div>

    <svg id="sldCanvas"></svg>

  </div>
</div>

<script>

// üî• JSON SOURCE
const JSON_URL =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/sld/boards_sld.json";

// ================= NAV =================
function goHome(){
  location.href="https://08electricaldata.github.io/";
}
function goBack(){
  history.back();
}

// ================= GET URL PARAM =================
function getParam(name){
  const url=new URL(window.location.href);
  return url.searchParams.get(name);
}

// ================= SVG HELPERS =================
const svg=document.getElementById("sldCanvas");

function clearSVG(){
  svg.innerHTML="";
}

function line(x1,y1,x2,y2,cls="black"){
  const l=document.createElementNS("http://www.w3.org/2000/svg","line");
  l.setAttribute("x1",x1);
  l.setAttribute("y1",y1);
  l.setAttribute("x2",x2);
  l.setAttribute("y2",y2);
  l.setAttribute("stroke",cls);
  l.setAttribute("stroke-width","3");
  svg.appendChild(l);
}

function text(x,y,str){
  const t=document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x",x);
  t.setAttribute("y",y);
  t.setAttribute("font-size","12");
  t.setAttribute("text-anchor","middle");
  t.textContent=str;
  svg.appendChild(t);
}

function breaker(x,y,label){
  const g=document.createElementNS("http://www.w3.org/2000/svg","g");

  const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
  r.setAttribute("x",x-18);
  r.setAttribute("y",y-12);
  r.setAttribute("width","36");
  r.setAttribute("height","24");
  r.setAttribute("fill","#fff");
  r.setAttribute("stroke","#000");
  r.setAttribute("stroke-width","2");

  const t=document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x",x);
  t.setAttribute("y",y+4);
  t.setAttribute("font-size","10");
  t.setAttribute("text-anchor","middle");
  t.textContent="CB";

  const lbl=document.createElementNS("http://www.w3.org/2000/svg","text");
  lbl.setAttribute("x",x);
  lbl.setAttribute("y",y+28);
  lbl.setAttribute("font-size","10");
  lbl.setAttribute("text-anchor","middle");
  lbl.textContent=label || "";

  g.appendChild(r);
  g.appendChild(t);
  g.appendChild(lbl);
  svg.appendChild(g);
}

// ================= LOAD =================
async function loadSLD(){

  const boardId=getParam("id");

  if(!boardId){
    document.getElementById("boardInfo").innerText="‚ùå Board id missing in URL";
    return;
  }

  document.getElementById("title").innerText=boardId+" ‚Äî SLD";

  const res=await fetch(JSON_URL);
  const data=await res.json();

  const board=data.boards?.[boardId];

  if(!board){
    document.getElementById("boardInfo").innerText="‚ùå Board not found in JSON";
    return;
  }

  document.getElementById("boardInfo").innerText=
    "Incomers: "+board.topology.totalIncomers+
    " | Bus Sections: "+board.topology.busSections.join(", ");

  drawSLD(board);
}

// ================= DRAW ENGINE =================
function drawSLD(board){

  clearSVG();

  const width=svg.clientWidth || 1200;

  // ===== BUS A =====
  line(80,260,width-80,260);

  // ===== BUS B (if exists) =====
  if(board.topology.busSections.includes("B")){
    line(80,320,width-80,320);
  }

  // ===== INCOMERS =====
  const incomers=[
    ...board.incomers,
    ...board.dgIncomers,
    ...board.emergencyIncomers
  ];

  const spacing=width/(incomers.length+1);

  incomers.forEach((inc,i)=>{

    const x=spacing*(i+1);
    const busY=(inc.bus==="B")?320:260;

    line(x,120,x,busY-20);
    breaker(x,busY-40,inc.breakerId);
  });

  // ===== BUS COUPLER =====
  if(board.busCouplers?.length){

    const x=width/2;

    line(x,260,x,320);
    breaker(x,290,board.busCouplers[0].breakerId);
  }

  // ===== OUTGOINGS =====
  const outSpacing=width/(board.outgoings.length+1);

  board.outgoings.forEach((o,i)=>{

    const x=outSpacing*(i+1);
    const busY=(o.bus==="B")?320:260;

    line(x,busY+20,x,460);
    breaker(x,busY+40,o.breakerId);
  });
}

// ================= START =================
loadSLD();

</script>

</body>
</html>
