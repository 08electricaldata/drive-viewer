<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Drive Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f2f6ff; }

/* ===== HEADER BAR (SAME AS INDEX) ===== */
.header-bar {
  position: sticky; top: 0; z-index: 1000;
  background: #f2f6ff; padding: 10px 12px;
  display: flex; align-items: center; gap: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

.header-title { flex: 1; text-align: center; }
.header-title h2 { margin: 0; color: #003f88; }
.header-title small { display: block; font-size: 15px; font-weight: 600; }

.icon-btn {
  background: #ffffff;
  color: #003f88;
  border: 1px solid #003f88;
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 18px;
  cursor: pointer;
  font-weight: bold;
}

.container { padding: 20px; }

.card {
  background: #fff; padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
  margin-bottom:20px;
}

.label { font-weight: bold; color: #003f88; }

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
}

/* ===== ACTION BUTTONS ===== */
.action-row {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:20px;
}

.action-btn {
  padding: 10px 18px;
  background: #003f88;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.action-btn:disabled {
  background:#ccc;
  cursor:not-allowed;
}

.badge {
  color:red;
  font-weight:bold;
  margin-top:10px;
}

/* ===== PLC TABLE STYLE ===== */
.section-title{
  font-weight:bold;
  margin:20px 0 10px;
  padding:8px;
  background:#e8edff;
  border-left:4px solid #003f88;
}

table{
  border-collapse:collapse;
  width:100%;
  background:#fff;
  font-size:13px;
}

th, td{
  border:1px solid #ccc;
  padding:6px;
  text-align:left;
}

th{
  background:#dbe4ff;
}

/* ===== DRAWING GRID ===== */
.group-title{
  margin-top:25px;
  font-weight:bold;
  color:#003f88;
  font-size:18px;
  border-bottom:2px solid #003f88;
  padding-bottom:5px
}

.draw-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:18px;
  margin-top:15px
}

.tile{
  background:#f8fbff;
  padding:12px;
  border-radius:10px;
  box-shadow:0 2px 5px rgba(0,0,0,.1);
  cursor:pointer;
  text-align:center;
  transition:.2s
}
.tile:hover{transform:scale(1.03)}

.tile img{
  width:100%;
  height:150px;
  object-fit:cover;
  border-radius:8px;
  margin-bottom:8px
}

.viewer{
  margin-top:30px;
  height:650px;
  border:1px solid #ccc;
  border-radius:10px;
  overflow:hidden;
  display:none;
}

.viewer iframe{
  width:100%;
  height:100%;
  border:none
}

.hidden{display:none}

@media(max-width:768px){
  .grid { grid-template-columns: 1fr; }
  .viewer{height:450px}
}
</style>
</head>

<body>

<div class="header-bar">
  <button class="icon-btn" onclick="goHome()">üè†</button>
  <button class="icon-btn" onclick="goBack()">‚¨Ö</button>
  <button class="icon-btn" onclick="addJob()">‚ûï</button>

  <div class="header-title">
    <h2 id="pageTitle">Drive Viewer</h2>
    <small>Designed and maintained by Rakesh Chandra Sethy</small>
  </div>
</div>

<div class="container">

  <!-- ===== INFO SECTION ===== -->
  <div id="infoSection" class="card"></div>

  <!-- ===== PLC SECTION ===== -->
  <div id="plcSection" class="card hidden"></div>

  <!-- ===== DRAWING SECTION ===== -->
  <div id="drawingSection" class="card hidden"></div>

  <!-- ===== HISTORY SECTION (PART 2) ===== -->
  <div id="historySection" class="card hidden"></div>

</div>

<script>

/* ===== JSON URLS ===== */
const DRIVE_JSON =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/drive.json";

const PLC_JSON =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/plc/plc.json";

const DRAWING_JSON =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/drawings/drawings.json";

/* ===== UTIL ===== */
function normalize(v){
  return String(v||"")
    .replace(/[‚Äì‚Äî?]/g,"-")
    .toUpperCase()
    .trim();
}

function getID(){
  return normalize(new URLSearchParams(location.search).get("id"));
}

function goHome(){ location.href="https://08electricaldata.github.io/"; }
function goBack(){ history.back(); }
function addJob(){
  const id=getID();
  location.href=
  "https://08electricaldata.github.io/qrsubmit.html?id="+encodeURIComponent(id);
}

/* ===== TAB SWITCH ===== */
function showSection(section){
  infoSection.classList.add("hidden");
  plcSection.classList.add("hidden");
  drawingSection.classList.add("hidden");
  historySection.classList.add("hidden");

  document.getElementById(section).classList.remove("hidden");
}

/* ===== LOAD INFO ===== */
async function loadInfo(id){

  const j = await (await fetch(DRIVE_JSON)).json();
  const c = j.rows.find(r=>normalize(`${r[1]}-${r[2]}`)===id);

  if(!c){
    infoSection.innerHTML="Drive not found.";
    return;
  }

  pageTitle.innerText=`${c[1]} ‚Äì ${c[2]}`;

  infoSection.innerHTML=`
    <h3>${c[1]} ‚Äì ${c[2]}</h3>
    <div class="grid">
      <p><span class="label">Rating:</span> ${c[5]}</p>
      <p><span class="label">FLC:</span> ${c[10]}</p>
      <p><span class="label">SFU:</span> ${c[14]}</p>
      <p><span class="label">Fuse:</span> ${c[15]}</p>
      <p><span class="label">Contactor:</span> ${c[16]}</p>
      <p><span class="label">Relay/VFD:</span> ${c[17]}</p>
    </div>

    <div class="action-row">
      <button class="action-btn" onclick="showSection('plcSection')">‚ö° PLC</button>
      <button class="action-btn" onclick="showSection('drawingSection')">üìê Drawings</button>
      <button class="action-btn" onclick="showSection('historySection')">üìú History</button>
    </div>
  `;
}

/* ===== LOAD PLC ===== */
async function loadPLC(id){

  const j = await (await fetch(PLC_JSON)).json();
  const drive = j.drives[id];

  if(!drive){
    plcSection.innerHTML="<div class='badge'>‚ö° No PLC Address Available</div>";
    return;
  }

  let html="";

  function buildTable(arr){
    let h=`<table><tr>
    <th>Signal</th><th>Tag</th><th>Address</th>
    <th>Description</th><th>Panel</th><th>TB No</th><th>RL</th>
    </tr>`;
    arr.forEach(r=>{
      h+=`<tr>
      <td>${r.signal||""}</td>
      <td>${r.tag||""}</td>
      <td>${r.address||""}</td>
      <td>${r.description||""}</td>
      <td>${r.panel||""}</td>
      <td>${r.tb||""}</td>
      <td>${r.rl||""}</td>
      </tr>`;
    });
    return h+"</table>";
  }

  if(drive.inputs?.length){
    html+=`<div class="section-title">INPUT SIGNALS</div>`+
    buildTable(drive.inputs);
  }

  if(drive.outputs?.length){
    html+=`<div class="section-title">OUTPUT SIGNALS</div>`+
    buildTable(drive.outputs);
  }

  plcSection.innerHTML=html;
}

/* ===== LOAD DRAWINGS ===== */
async function loadDrawings(id){

  const j = await (await fetch(DRAWING_JSON)).json();
  const item = j.rows.find(r=>normalize(r.id)===id);

  if(!item){
    drawingSection.innerHTML="<div class='badge'>üé® No Drawings Available</div>";
    return;
  }

  let html=`<h3>${id}</h3>`;

  Object.keys(item).forEach(group=>{
    if(group==="id") return;
    if(!Array.isArray(item[group])) return;

    html+=`<div class="group-title">${group.toUpperCase()}</div>
           <div class="draw-grid">`;

    item[group].forEach((link,i)=>{
      if(!link) return;

      html+=`
      <div class="tile"
        onclick="openDrawing('${link}')">
        <img src="https://drive.google.com/thumbnail?id=${link.match(/[-\w]{25,}/)}">
        <h4>Drawing ${i+1}</h4>
      </div>`;
    });

    html+=`</div>`;
  });

  html+=`
    <div class="viewer" id="viewerBox">
      <iframe id="pdfFrame"></iframe>
    </div>
  `;

  drawingSection.innerHTML=html;
}

function openDrawing(link){
  const id=link.match(/[-\w]{25,}/);
  pdfFrame.src="https://drive.google.com/file/d/"+id+"/preview";
  viewerBox.style.display="block";
}

/* ===== INIT ===== */
(async function(){
  const id=getID();
  if(!id) return;

  await loadInfo(id);
  await loadPLC(id);
  await loadDrawings(id);
})();
  
/* =========================
   ===== HISTORY SYSTEM =====
   ========================= */

const JOBBOOK_JSON =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/jobbook.json";

const HISTORY_YEARS = [2026,2025,2024,2023,2022,2021,2020,2019];

const HISTORY_BASE =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/history/";

let jobBookMap = {};

/* ===== DATE NORMALIZER ===== */
function normalizeDateKey(v){
  if(!v) return "";
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v;

  if(typeof v==="string" && v.startsWith("Date(")){
    const p=v.match(/\d+/g);
    const d=new Date(p[0],p[1],p[2]);
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
  }

  const d=new Date(v);
  if(!isNaN(d)){
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
  }

  return "";
}

function formatDate(v){
  const key=normalizeDateKey(v);
  if(!key) return "";
  const[d,m,y]=key.split("/");
  return `${d}-${m}-${y}`;
}

/* ===== LOAD JOBBOOK ===== */
async function loadJobBook(){
  try{
    const r = await fetch(JOBBOOK_JSON);
    const j = await r.json();

    j.rows.forEach(r=>{
      const key = normalizeDateKey(r[0]);
      if(key && r[1]) jobBookMap[key] = r[1];
    });

  }catch(e){}
}

/* ===== LOAD HISTORY ===== */
async function loadHistory(id){

  let all = [];

  for(const y of HISTORY_YEARS){
    try{
      const r = await fetch(HISTORY_BASE+y+".json");
      if(!r.ok) continue;

      const j = await r.json();

      j.rows.forEach(row=>{
        if(normalize(`${row[2]}-${row[3]}`) === id){
          all.push(row);
        }
      });

    }catch(e){}
  }

  all.sort((a,b)=>new Date(b[4])-new Date(a[4]));

  renderHistoryTable(all);
}

/* ===== RENDER HISTORY ===== */
function renderHistoryTable(rows){

  let html = `
  <h2 style="text-align:center;color:#003f88;">Drive History</h2>

  <div class="controls">
    <input id="searchBox" placeholder="Search‚Ä¶">
    <button onclick="exportExcel()">Export Excel</button>
    <button onclick="window.print()">Export PDF</button>
  </div>

  <table id="historyTable">
    <thead>
      <tr>
        <th>TR NO</th>
        <th>MONTH</th>
        <th>DATE</th>
        <th>DETAILS OF JOB</th>
        <th>JOB TYPE</th>
        <th>JOB CATEGORY</th>
        <th>CARRIED OUT BY</th>
        <th>LINK</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  `;

  historySection.innerHTML = html;

  const tbody = historySection.querySelector("tbody");

  let currentYear = "";

  rows.forEach(r=>{

    const key = normalizeDateKey(r[4]);
    const year = key.slice(-4);

    if(year !== currentYear){
      currentYear = year;
      const yr = document.createElement("tr");
      yr.className = "year-row";
      yr.innerHTML = `<td colspan="8" style="background:#e8f0ff;color:#003f88;font-weight:700;text-align:center;">YEAR ${year}</td>`;
      tbody.appendChild(yr);
    }

    const link = jobBookMap[key] || r[10];

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r[0]||""}</td>
      <td>${r[1]||""}</td>
      <td>${formatDate(r[4])}</td>
      <td>${r[5]||""}</td>
      <td>${r[6]||""}</td>
      <td>${r[7]||""}</td>
      <td>${r[9]||""}</td>
      <td>${link?`<a href="${link}" target="_blank">Open</a>`:""}</td>
    `;
    tbody.appendChild(tr);
  });

  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No history found</td></tr>`;
  }

  /* ===== SEARCH FILTER ===== */
  document.getElementById("searchBox").addEventListener("input",function(){
    const v = this.value.toLowerCase();
    historySection.querySelectorAll("tbody tr").forEach(tr=>{
      tr.style.display = tr.innerText.toLowerCase().includes(v) ? "" : "none";
    });
  });

}

/* ===== EXPORT EXCEL ===== */
function exportExcel(){
  let csv=[];
  historySection.querySelectorAll("table tr").forEach(r=>{
    csv.push([...r.children].map(c=>`"${c.innerText}"`).join(","));
  });

  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv.join("\n")]));
  a.download="drive-history.csv";
  a.click();
}

/* ===== MODIFY INIT TO LOAD HISTORY ===== */
(async function(){

  const id = getID();
  if(!id) return;

  await loadJobBook();
  await loadHistory(id);

})();

</script>

</body>
</html>
