<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Drive Unified Industrial Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

/* ================= BODY ================= */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f2f6ff;
}

/* ================= HEADER ================= */
.header-bar {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #f2f6ff;
  padding: 10px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

.header-title { flex: 1; text-align: center; }
.header-title h2 { margin: 0; color: #003f88; }
.header-title small { display: block; font-size: 15px; font-weight: 600; }

.icon-btn {
  background: #ffffff;
  color: #003f88;
  border: 1px solid #003f88;
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 16px;
  cursor: pointer;
  font-weight: bold;
}

/* ================= TAB BAR ================= */
.tab-bar {
  display: flex;
  justify-content: center;
  gap: 12px;
  padding: 12px;
  background: #e8f0ff;
  flex-wrap: wrap;
  border-bottom: 2px solid #003f88;
}

.tab-btn {
  background: #ffffff;
  border: 2px solid #003f88;
  color: #003f88;
  padding: 8px 18px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: 700;
  transition: .2s;
}

.tab-btn.active {
  background: #003f88;
  color: white;
}

.tab-btn:disabled {
  background: #ccc;
  border-color: #ccc;
  color: #666;
  cursor: not-allowed;
}

/* PLC GREEN INDICATOR */
#plcIndicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  background: limegreen;
  border-radius: 50%;
  margin-left: 6px;
}

/* DRAWING BADGE */
#drawingBadge {
  background: red;
  color: white;
  border-radius: 50%;
  padding: 2px 7px;
  font-size: 11px;
  margin-left: 6px;
}

/* ================= CONTAINER ================= */
.container {
  padding: 20px;
  max-width: 1400px;
  margin: auto;
}

/* ================= COMMON CARD ================= */
.card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
  margin-bottom: 20px;
}

.label {
  font-weight: bold;
  color: #003f88;
}

/* ================= GRID ================= */
.grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
}

/* ================= TABLE ================= */
table {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  margin-bottom: 25px;
  font-size: 14px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  text-align: left;
}

th {
  background: #003f88;
  color: white;
}

tr:hover {
  background: #f2f6ff;
}

.no-data {
  text-align: center;
  color: red;
  font-weight: bold;
  padding: 20px;
}

/* ================= MOBILE ================= */
@media(max-width:768px){
  .grid { grid-template-columns: 1fr; }
}

</style>
</head>

<body>

<div class="header-bar">
  <button class="icon-btn" onclick="goHome()">üè† Home</button>
  <button class="icon-btn" onclick="goBack()">‚¨Ö Back</button>
  <button class="icon-btn" onclick="addJob()">‚ûï ADD JOB</button>
  <div class="header-title">
    <h2>Drive Unified Industrial Dashboard</h2>
    <small>Designed and maintained by Rakesh Chandra Sethy</small>
  </div>
</div>

<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('info',this)">‚ÑπÔ∏è Drive Info</button>
  <button class="tab-btn" id="plcTabBtn" onclick="switchTab('plc',this)">
    ‚ö° PLC <span id="plcIndicator"></span>
  </button>
  <button class="tab-btn" id="drawingTabBtn" onclick="switchTab('drawings',this)">
    üìê Drawings <span id="drawingBadge"></span>
  </button>
  <button class="tab-btn" onclick="switchTab('history',this)">üìú History</button>
</div>

<div class="container">
  <div id="tabContent">Loading...</div>
</div>

<script>

/* ========= GLOBAL CONSTANTS ========= */

const DRIVE_JSON =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/drive.json";

const PLC_JSON =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/plc/plc.json";

const DRAWING_JSON =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/drawings/drawings.json";

const HISTORY_BASE =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/history/";

const JOBBOOK_JSON =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/jobbook.json";

const HISTORY_YEARS=[2026,2025,2024,2023,2022,2021,2020,2019];

/* ========= BASIC NAV ========= */

function normalize(v){
  return String(v || "")
    .replace(/[‚Äì‚Äî?]/g, "-")
    .toUpperCase()
    .trim();
}

function getID(){
  return normalize(new URLSearchParams(location.search).get("id"));
}

function goHome(){
  location.href="https://08electricaldata.github.io/";
}

function goBack(){
  history.back();
}

function addJob(){
  const id=getID();
  if(!id) return;
  location.href =
  "https://08electricaldata.github.io/qrsubmit.html?id="+
  encodeURIComponent(id);
}

/* ========= TAB SWITCH ========= */

function switchTab(tab,btn){
  document.querySelectorAll(".tab-btn")
    .forEach(b=>b.classList.remove("active"));
  if(btn) btn.classList.add("active");

  if(tab==="info") loadDriveInfo();
  if(tab==="plc") loadPLC();
  if(tab==="drawings") loadDrawings();
  if(tab==="history") loadHistory();
}

/* =========================================================
   PRELOAD DRAWING + PLC STATUS
========================================================= */

let drawingAvailableMap = {};
let plcAvailableMap = {};

async function preloadDrawings(){
  try{
    const j = await (await fetch(DRAWING_JSON)).json();
    j.rows.forEach(item=>{
      const id = normalize(item.id);
      if(!id) return;

      const hasDrawing = Object.keys(item).some(k=>{
        if(k==="id") return false;
        if(!Array.isArray(item[k])) return false;
        return item[k].some(link=>link && link.trim()!=="");
      });

      drawingAvailableMap[id] = hasDrawing;
    });
  }catch(e){}
}

async function preloadPLC(){
  try{
    const j = await (await fetch(PLC_JSON)).json();
    Object.keys(j.drives || {}).forEach(id=>{
      plcAvailableMap[normalize(id)] = true;
    });
  }catch(e){}
}

/* =========================================================
   DATE UTILITIES (same as original)
========================================================= */

function parseDate(v){
  if(!v) return null;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){
    const[d,m,y]=v.split("/");
    return new Date(y,m-1,d);
  }
  return new Date(v);
}

function fmt(d){
  if(!d || isNaN(d)) return "NO RECORDS";
  return `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
}

/* =========================================================
   LAST DATE FINDER (same industrial logic)
========================================================= */

async function lastDates(id,map){
  const res={};
  Object.keys(map).forEach(k=>res[k]=null);

  for(const y of HISTORY_YEARS){
    try{
      const j = await (await fetch(HISTORY_BASE + y + ".json")).json();
      j.rows.forEach(r=>{
        if(normalize(`${r[2]}-${r[3]}`) !== id) return;

        const job = normalize(r[7]);
        const d = parseDate(r[4]);

        Object.entries(map).forEach(([k,v])=>{
          if(job === normalize(v) && (!res[k] || d > res[k])) {
            res[k] = d;
          }
        });
      });
    }catch(e){}
  }

  Object.keys(res).forEach(
    k => res[k] = res[k] ? fmt(res[k]) : "NO RECORDS"
  );
  return res;
}

/* =========================================================
   APPLY TAB INDICATORS
========================================================= */

function applyTabIndicators(id){

  const plcBtn = document.getElementById("plcTabBtn");
  const drawBtn = document.getElementById("drawingTabBtn");

  if(!plcAvailableMap[id]){
    document.getElementById("plcIndicator").style.display="none";
    plcBtn.disabled = true;
  }

  if(!drawingAvailableMap[id]){
    drawBtn.disabled = true;
  }else{
    document.getElementById("drawingBadge").innerText = "‚óè";
  }
}

/* =========================================================
   MAIN DRIVE INFO LOADER (FULL ORIGINAL STRUCTURE)
========================================================= */

async function loadDriveInfo(){

  const id = getID();
  if(!id) return;

  const j = await (await fetch(DRIVE_JSON)).json();

  const c = j.rows.find(
    r => normalize(`${r[1]}-${r[2]}`) === id
  );

  if(!c){
    tabContent.innerHTML =
      "<div class='card'>Drive Data Not Found</div>";
    return;
  }

  applyTabIndicators(id);

  const TYPE = normalize(c[1]);

  if(TYPE === "TRANSFORMER") return showTransformer(c,id);
  if(TYPE === "BREAKER") return showBreaker(c,id);
  return showMotor(c,id);
}

/* =========================================================
   MOTOR VIEW (FULL ORIGINAL GRID)
========================================================= */

async function showMotor(c,id){

  const p = await lastDates(id,{
    rep:"MOTOR REPLACEMENT",
    pm:"MOTOR PM",
    mod:"MODULE PM",
    vfd:"VFD PM"
  });

  tabContent.innerHTML = `
  <div class="card">
    <h3>${c[1]} ‚Äì ${c[2]}</h3>
    <div class="grid">
      <p><span class="label">Rating:</span> ${c[5]} KW</p>
      <p><span class="label">FLC:</span> ${c[10]} A</p>
      <p><span class="label">SFU:</span> ${c[14]}</p>
      <p><span class="label">Fuse:</span> ${c[15]}</p>
      <p><span class="label">Contactor:</span> ${c[16]}</p>
      <p><span class="label">Relay/VFD:</span> ${c[17]}</p>
      <p><span class="label">CT (M):</span> ${c[18]}</p>
      <p><span class="label">CT (P):</span> ${c[19]}</p>
      <p><span class="label">Aux Contactor:</span> ${c[20]}</p>
      <p><span class="label">Ammeter:</span> ${c[21]}</p>
      <p><span class="label">Ind Lamp:</span> ${c[22]}</p>
      <p><span class="label">No of Spare Motors:</span> ${c[23]}</p>

      <p><span class="label">Last Motor Replacement:</span> ${p.rep}</p>
      <p><span class="label">Last Motor PM:</span> ${p.pm}</p>
      <p><span class="label">Last Module PM:</span> ${p.mod}</p>
      <p><span class="label">Last VFD PM:</span> ${p.vfd}</p>
    </div>
  </div>`;
}

/* =========================================================
   TRANSFORMER VIEW
========================================================= */

async function showTransformer(c,id){

  const t = await lastDates(id,{
    pm:"TRANSFORMER PM",
    oh:"TRANSFORMER O/H",
    leak:"TRANSFORMER L/A",
    top:"OIL TUPOP",
    chk:"T/F OIL CHECK"
  });

  tabContent.innerHTML = `
  <div class="card">
    <h3>Transformer ‚Äì ${c[2]}</h3>
    <div class="grid">
      <p><span class="label">TR Sl No:</span> ${c[3]}</p>
      <p><span class="label">Make:</span> ${c[4]}</p>
      <p><span class="label">Rating:</span> ${c[5]} KVA</p>
      <p><span class="label">From S/S:</span> ${c[6]}</p>
      <p><span class="label">Unit S/S:</span> ${c[7]}</p>
      <p><span class="label">% Impedance:</span> ${c[8]}</p>
      <p><span class="label">LT SWBD:</span> ${c[9]}</p>
      <p><span class="label">Panel Rating:</span> ${c[10]}</p>

      <p><span class="label">Last Transformer PM:</span> ${t.pm}</p>
      <p><span class="label">Last Transformer O/H:</span> ${t.oh}</p>
      <p><span class="label">Last Oil Leakage Arrest:</span> ${t.leak}</p>
      <p><span class="label">Last Oil Top-up:</span> ${t.top}</p>
      <p><span class="label">Last Oil Checked:</span> ${t.chk}</p>
    </div>
  </div>`;
}

/* =========================================================
   BREAKER VIEW
========================================================= */

async function showBreaker(c,id){

  const b = await lastDates(id,{ pm:"BREAKER PM" });

  tabContent.innerHTML = `
  <div class="card">
    <h3>Breaker ‚Äì ${c[2]}</h3>
    <div class="grid">
      <p><span class="label">Compartment No:</span> ${c[3]}</p>
      <p><span class="label">Breaker Desc:</span> ${c[4]}</p>
      <p><span class="label">Make:</span> ${c[5]}</p>
      <p><span class="label">Rating:</span> ${c[6]} A</p>
      <p><span class="label">Type:</span> ${c[7]}</p>
      <p><span class="label">LT SWBD:</span> ${c[9]}</p>
      <p><span class="label">Panel Rating:</span> ${c[10]}</p>

      <p><span class="label">Last Breaker PM:</span> ${b.pm}</p>
    </div>
  </div>`;
}

/* =========================================================
   INIT FOR PART 2
========================================================= */

(async function(){
  await preloadDrawings();
  await preloadPLC();
  loadDriveInfo();
})();
/* =========================================================
   FULL PLC INDUSTRIAL SYSTEM
========================================================= */

function createPLCTable(title, dataArray){

  let html = `
    <div class="card">
      <div style="font-weight:bold;margin-bottom:10px;">
        ${title}
      </div>
      <table>
        <thead>
          <tr>
            <th>Signal</th>
            <th>Tag</th>
            <th>Address</th>
            <th>Description</th>
            <th>Panel</th>
            <th>TB No</th>
            <th>RL</th>
          </tr>
        </thead>
        <tbody>
  `;

  dataArray.forEach(row=>{
    html += `
      <tr>
        <td>${row.signal || ""}</td>
        <td>${row.tag || ""}</td>
        <td>${row.address || ""}</td>
        <td>${row.description || ""}</td>
        <td>${row.panel || ""}</td>
        <td>${row.tb || ""}</td>
        <td>${row.rl || ""}</td>
      </tr>
    `;
  });

  html += `</tbody></table></div>`;
  return html;
}

/* =========================================================
   LOAD PLC (FULL VERSION)
========================================================= */

async function loadPLC(){

  const id = getID();
  if(!id) return;

  try{

    const response = await fetch(PLC_JSON);
    const data = await response.json();

    const drive = data.drives[id];

    if(!drive){
      tabContent.innerHTML = `
        <div class="card no-data">
          No PLC data found for: ${id}
        </div>
      `;
      return;
    }

    let html = `
      <div class="card">
        <h3 style="text-align:center;">
          PLC ADDRESS OF DRIVE ‚Äî ${id}
        </h3>
        <div style="text-align:center;color:#555;margin-top:6px;">
          Last Updated: ${new Date(data.updated).toLocaleString("en-GB")}
        </div>
      </div>
    `;

    if(drive.inputs && drive.inputs.length){
      html += createPLCTable("INPUT SIGNALS", drive.inputs);
    }

    if(drive.outputs && drive.outputs.length){
      html += createPLCTable("OUTPUT SIGNALS", drive.outputs);
    }

    tabContent.innerHTML = html;

  }catch(err){

    tabContent.innerHTML = `
      <div class="card no-data">
        Error loading PLC JSON file.
      </div>
    `;
    console.error(err);
  }
}
/* =========================================================
   FULL DRAWING INDUSTRIAL SYSTEM
========================================================= */

function getFileId(link){
  const match = link.match(/[-\w]{25,}/);
  return match ? match[0] : null;
}

function convertToEmbed(link){
  const fileId = getFileId(link);
  if(!fileId) return link;
  return "https://drive.google.com/file/d/"+fileId+"/preview";
}

function convertToThumbnail(link){
  const fileId = getFileId(link);
  if(!fileId) return "";
  return "https://drive.google.com/thumbnail?id="+fileId;
}

function incrementDownload(id,index){
  const key="draw_"+id+"_"+index;
  let count=localStorage.getItem(key);
  count = count ? Number(count)+1 : 1;
  localStorage.setItem(key,count);
  return count;
}

function getDownload(id,index){
  return localStorage.getItem("draw_"+id+"_"+index)||0;
}

async function loadDrawings(){

  const id = getID();
  if(!id) return;

  const j = await (await fetch(DRAWING_JSON)).json();
  const item = j.rows.find(r=>normalize(r.id)===id);

  if(!item){
    tabContent.innerHTML =
      "<div class='card no-data'>No Drawings Available</div>";
    return;
  }

  let html=`<div class="card">
              <h3>${id}</h3>`;

  Object.keys(item).forEach(group=>{
    if(group==="id") return;
    if(!Array.isArray(item[group])) return;

    html+=`<div style="margin-top:25px;font-weight:bold;
             color:#003f88;font-size:18px;
             border-bottom:2px solid #003f88;
             padding-bottom:5px">
             ${group.toUpperCase()}
            </div>
           <div style="display:grid;
                grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
                gap:18px;margin-top:15px">`;

    item[group].forEach((link,i)=>{
      if(!link) return;

      const thumb = convertToThumbnail(link);
      const count = getDownload(id,i);

      html+=`
        <div style="background:#f8fbff;padding:12px;
             border-radius:10px;
             box-shadow:0 2px 5px rgba(0,0,0,.1);
             cursor:pointer;text-align:center"
             onclick="openDrawing('${id}',${i},'${link}')">

          <img src="${thumb}"
               style="width:100%;height:150px;
                      object-fit:cover;border-radius:8px;
                      margin-bottom:8px"
               onerror="this.src='https://via.placeholder.com/300x200?text=PDF'">

          <div style="font-size:14px;color:#003f88">
            Drawing ${i+1}
          </div>

          <div style="font-size:12px;color:#666"
               id="count_${i}">
            Downloads: ${count}
          </div>
        </div>`;
    });

    html+=`</div>`;
  });

  html+=`
        <div id="viewerBox"
             style="margin-top:30px;height:650px;
             border:1px solid #ccc;border-radius:10px;
             overflow:hidden;display:none">
          <iframe id="pdfFrame"
                  style="width:100%;height:100%;border:none"></iframe>
        </div>

        <div style="margin-top:10px;text-align:right">
          <button onclick="toggleFullScreen()"
                  style="padding:8px 14px;
                  background:#003f88;color:white;
                  border:none;border-radius:6px">
            üì± Full Screen
          </button>

          <button onclick="printDrawing()"
                  style="padding:8px 14px;
                  background:#003f88;color:white;
                  border:none;border-radius:6px">
            üñ® Print
          </button>
        </div>
        </div>`;

  tabContent.innerHTML=html;
}

function openDrawing(id,index,link){
  const embed = convertToEmbed(link);
  const frame = document.getElementById("pdfFrame");
  const viewer = document.getElementById("viewerBox");

  frame.src = embed;
  viewer.style.display="block";

  const newCount = incrementDownload(id,index);
  document.getElementById("count_"+index).innerText =
    "Downloads: "+newCount;
}

function printDrawing(){
  const frame=document.getElementById("pdfFrame");
  if(frame && frame.contentWindow){
    frame.contentWindow.print();
  }
}

function toggleFullScreen(){
  const viewer=document.getElementById("viewerBox");
  viewer.style.position="fixed";
  viewer.style.top="0";
  viewer.style.left="0";
  viewer.style.width="100%";
  viewer.style.height="100%";
  viewer.style.zIndex="9999";
  viewer.style.background="white";
}


/* =========================================================
   FULL HISTORY INDUSTRIAL SYSTEM
========================================================= */

let jobBookMap = {};

function normalizeDateKey(v){
  if(!v) return "";
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v;
  const d=new Date(v);
  if(!isNaN(d)){
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
  }
  return "";
}

function formatDate(v){
  const key=normalizeDateKey(v);
  if(!key) return "";
  const[d,m,y]=key.split("/");
  return `${d}-${m}-${y}`;
}

async function loadJobBook(){
  const r = await fetch(JOBBOOK_JSON);
  const j = await r.json();
  j.rows.forEach(r=>{
    const key = normalizeDateKey(r[0]);
    if(key && r[1]) jobBookMap[key] = r[1];
  });
}

async function loadHistory(){

  const id = getID();
  if(!id) return;

  await loadJobBook();

  let all=[];

  for(const y of HISTORY_YEARS){
    try{
      const r=await fetch(HISTORY_BASE+y+".json");
      if(!r.ok) continue;
      const j=await r.json();
      j.rows.forEach(row=>{
        if(normalize(`${row[2]}-${row[3]}`) === id){
          all.push(row);
        }
      });
    }catch(e){}
  }

  all.sort((a,b)=>new Date(b[4])-new Date(a[4]));

  if(!all.length){
    tabContent.innerHTML =
      "<div class='card no-data'>No history found</div>";
    return;
  }

  let html=`<div class="card">
            <h3 style="text-align:center">Drive History</h3>

            <div style="margin-bottom:10px">
              <input id="search"
                     placeholder="Search..."
                     style="padding:6px;width:220px">
              <button onclick="exportExcel()"
                      style="padding:6px 12px;
                      background:#003f88;color:white;
                      border:none;border-radius:4px">
                Export Excel
              </button>
              <button onclick="window.print()"
                      style="padding:6px 12px;
                      background:#003f88;color:white;
                      border:none;border-radius:4px">
                Export PDF
              </button>
            </div>

            <table id="historyTable">
              <thead>
                <tr>
                  <th>TR NO</th>
                  <th>MONTH</th>
                  <th>DATE</th>
                  <th>DETAILS OF JOB</th>
                  <th>JOB TYPE</th>
                  <th>JOB CATEGORY</th>
                  <th>CARRIED OUT BY</th>
                  <th>LINK</th>
                </tr>
              </thead>
              <tbody>
            `;

  let currentYear="";

  all.forEach(r=>{
    const key=normalizeDateKey(r[4]);
    const y=key.slice(-4);

    if(y!==currentYear){
      currentYear=y;
      html+=`
        <tr style="background:#e8f0ff;
                   color:#003f88;font-weight:700">
          <td colspan="8">YEAR ${y}</td>
        </tr>`;
    }

    const link = jobBookMap[key] || r[10];

    html+=`
      <tr>
        <td>${r[0]||""}</td>
        <td>${r[1]||""}</td>
        <td>${formatDate(r[4])}</td>
        <td>${r[5]||""}</td>
        <td>${r[6]||""}</td>
        <td>${r[7]||""}</td>
        <td>${r[9]||""}</td>
        <td>${link?`<a href="${link}" target="_blank">Open</a>`:""}</td>
      </tr>`;
  });

  html+=`</tbody></table></div>`;

  tabContent.innerHTML=html;

  document.getElementById("search")
    .addEventListener("input",function(){
      const v=this.value.toLowerCase();
      document.querySelectorAll("#historyTable tbody tr")
        .forEach(tr=>{
          tr.style.display=
            tr.innerText.toLowerCase().includes(v)
            ? "" : "none";
        });
    });
}

function exportExcel(){
  let csv=[];
  document.querySelectorAll("#historyTable tr")
    .forEach(r=>{
      csv.push([...r.children]
        .map(c=>`"${c.innerText}"`).join(","));
    });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(
    new Blob([csv.join("\n")])
  );
  a.download="drive-history.csv";
  a.click();
}
