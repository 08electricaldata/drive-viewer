<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Equipment Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f2f6ff; }

.header-bar {
  position: sticky; top: 0; z-index: 1000;
  background: #f2f6ff; padding: 10px 12px;
  display: flex; align-items: center; gap: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

.header-title { flex: 1; text-align: center; }
.header-title h2 { margin: 0; color: #003f88; }
.header-title small { display: block; font-size: 15px; font-weight: 600; }

.icon-btn {
  background: #ffffff;
  color: #003f88;
  border: 1px solid #003f88;
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 18px;
  cursor: pointer;
  font-weight: bold;
}

.container { padding: 20px; }

.card {
  background: #fff; padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

.label { font-weight: bold; color: #003f88; }

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
}

.action-btn {
  margin-top: 20px;
  padding: 10px 18px;
  background: #003f88;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.action-btn:disabled {
  background:#ccc;
  cursor:not-allowed;
}

.badge {
  color:red;
  font-weight:bold;
  margin-top:10px;
}

@media(max-width:768px){
  .grid { grid-template-columns: 1fr; }
  .action-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 18px;
  }
  .action-row .action-btn {
    margin-top: 0;
    width: 100%;
  }
}
</style>
</head>

<body>

<div class="header-bar">
  <button class="icon-btn" onclick="goHome()">üè† Home</button>
  <button class="icon-btn" onclick="goBack()">‚¨Ö Back</button>
  <button class="icon-btn" onclick="addJob()">‚ûï ADD JOB</button>
  <div class="header-title">
    <h2>Equipment Information</h2>
    <small>Designed and maintained by Rakesh Chandra Sethy</small>
  </div>
</div>

<div class="container">
  <div id="content">Loading data‚Ä¶</div>
</div>

<script>
/* ================= ULTRA FAST CACHE ================= */

const CACHE = {
  drive: null,
  plc: null,
  drawings: null,
  history: {}
};

function fetchCached(url, key){
  if(CACHE[key]) return Promise.resolve(CACHE[key]);
  return fetch(url)
    .then(r=>r.json())
    .then(j=>{
      CACHE[key]=j;
      return j;
    });
}

/* ================= CONSTANTS ================= */

const DRIVE_JSON="https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/drive.json";
const DRAWING_JSON="https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/drawings/drawings.json";
const PLC_JSON="https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/plc/plc.json";
const HISTORY_BASE="https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/history/";
const HISTORY_YEARS=[2026,2025,2024,2023,2022,2021,2020,2019];

let drawingAvailableMap={};
let plcAvailableMap={};

/* ================= BASIC ================= */

function normalize(v){
  return String(v||"").replace(/[‚Äì‚Äî?]/g,"-").toUpperCase().trim();
}

function getID(){
  return normalize(new URLSearchParams(location.search).get("id"));
}

function goHome(){ location.href="https://08electricaldata.github.io/"; }
function goBack(){ history.back(); }

function addJob(){
  const id=getID();
  if(!id) return;
  location.href="https://08electricaldata.github.io/qrsubmit.html?id="+encodeURIComponent(id);
}

function openDrawings(){
  const id=getID();
  location.href="https://08electricaldata.github.io/drive-viewer/drawing.html?id="+encodeURIComponent(id);
}

function openPLC(){
  const id=getID();
  location.href="https://08electricaldata.github.io/drive-viewer/plc.html?id="+encodeURIComponent(id);
}

function openHistory(){
  const id=getID();
  location.href="https://08electricaldata.github.io/drive-viewer/history.html?id="+encodeURIComponent(id);
}

/* ================= PRELOAD ================= */

async function preloadDrawings(){
  const j=await fetchCached(DRAWING_JSON,"drawings");
  j.rows.forEach(item=>{
    const id=normalize(item.id);
    if(!id) return;

    const hasDrawing=Object.keys(item).some(k=>{
      if(k==="id") return false;
      if(!Array.isArray(item[k])) return false;
      return item[k].some(link=>link && link.trim()!=="");
    });

    drawingAvailableMap[id]=hasDrawing;
  });
}

async function preloadPLC(){
  const j=await fetchCached(PLC_JSON,"plc");
  Object.keys(j.drives||{}).forEach(id=>{
    plcAvailableMap[normalize(id)]=true;
  });
}

/* ================= DATE ================= */

function parseDate(v){
  if(!v) return null;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){
    const[d,m,y]=v.split("/");
    return new Date(y,m-1,d);
  }
  return new Date(v);
}

function fmt(d){
  if(!d||isNaN(d)) return "NO RECORDS";
  return `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
}

/* ================= ULTRA FAST LAST DATE ================= */

async function lastDates(id,map){

  const res={};
  Object.keys(map).forEach(k=>res[k]=null);

  await Promise.all(
    HISTORY_YEARS.map(async(y)=>{
      try{

        if(!CACHE.history[y]){
          CACHE.history[y]=await fetch(HISTORY_BASE+y+".json").then(r=>r.json());
        }

        const j=CACHE.history[y];

        j.rows.forEach(r=>{
          if(normalize(`${r[2]}-${r[3]}`)!==id) return;

          const job=normalize(r[7]);
          const d=parseDate(r[4]);

          Object.entries(map).forEach(([k,v])=>{
            if(job===normalize(v)&&(!res[k]||d>res[k])){
              res[k]=d;
            }
          });
        });

      }catch(e){}
    })
  );

  Object.keys(res).forEach(k=>res[k]=res[k]?fmt(res[k]):"NO RECORDS");
  return res;
}

/* ================= BUTTON STATE ================= */

function applyButtonState(id){
  const drawBtn=document.getElementById("drawBtn");
  const plcBtn=document.getElementById("plcBtn");

  if(drawBtn && !drawingAvailableMap[id]){
    drawBtn.disabled=true;
    drawBtn.insertAdjacentHTML("afterend","<div class='badge'>üé® No Drawing Available</div>");
  }

  if(plcBtn && !plcAvailableMap[id]){
    plcBtn.disabled=true;
    plcBtn.insertAdjacentHTML("afterend","<div class='badge'>‚ö° No PLC Address Available</div>");
  }
}

/* ================= LOAD DATA ================= */

async function loadData(){

  const id=getID();
  if(!id) return;

  const j=await fetchCached(DRIVE_JSON,"drive");

  const c=j.rows.find(r=>normalize(`${r[1]}-${r[2]}`)===id);

  /* üî¥ AUTO REDIRECT IF NOT FOUND */
  if(!c){
    location.replace(
      "https://08electricaldata.github.io/drive-viewer/history.html?id="+
      encodeURIComponent(id)
    );
    return;
  }

  const TYPE=normalize(c[1]);

  if(TYPE==="TRANSFORMER") showTransformer(c,id);
  else if(TYPE==="BREAKER") showBreaker(c,id);
  else showMotor(c,id);
}

/* ================= MOTOR ================= */

async function showMotor(c,id){

  const p=await lastDates(id,{
    rep:"MOTOR REPLACEMENT",
    pm:"MOTOR PM",
    mod:"MODULE PM",
    vfd:"VFD PM"
  });

  content.innerHTML=`
  <div class="card">
    <h3>${c[1]} ‚Äì ${c[2]}</h3>
    <div class="grid">
      <p><span class="label">Rating:</span> ${c[5]} KW</p>
      <p><span class="label">FLC:</span> ${c[10]} A</p>
      <p><span class="label">Last Motor PM:</span> ${p.pm}</p>
      <p><span class="label">Last VFD PM:</span> ${p.vfd}</p>
    </div>

    <div class="action-row">
      <button class="action-btn" onclick="openHistory()">üìú History</button>
      <button class="action-btn" id="drawBtn" onclick="openDrawings()">üìê Drawings</button>
      <button class="action-btn" id="plcBtn" onclick="openPLC()">‚ö° PLC-ADD</button>
      <button class="action-btn" onclick="addJob()">‚ûï ADD JOB</button>
    </div>
  </div>`;

  applyButtonState(id);
}

/* ================= TRANSFORMER ================= */

async function showTransformer(c,id){

  const t=await lastDates(id,{
    pm:"TRANSFORMER PM",
    oh:"TRANSFORMER O/H"
  });

  content.innerHTML=`
  <div class="card">
    <h3>Transformer ‚Äì ${c[2]}</h3>
    <div class="grid">
      <p><span class="label">Rating:</span> ${c[5]} KVA</p>
      <p><span class="label">Last Transformer PM:</span> ${t.pm}</p>
    </div>

    <div class="action-row">
      <button class="action-btn" onclick="openHistory()">üìú History</button>
      <button class="action-btn" id="drawBtn" onclick="openDrawings()">üìê Drawings</button>
      <button class="action-btn" id="plcBtn" onclick="openPLC()">‚ö° PLC-ADD</button>
      <button class="action-btn" onclick="addJob()">‚ûï ADD JOB</button>
    </div>
  </div>`;

  applyButtonState(id);
}

/* ================= BREAKER ================= */

async function showBreaker(c,id){

  const b=await lastDates(id,{ pm:"BREAKER PM" });

  content.innerHTML=`
  <div class="card">
    <h3>Breaker ‚Äì ${c[2]}</h3>
    <div class="grid">
      <p><span class="label">Rating:</span> ${c[6]} A</p>
      <p><span class="label">Last Breaker PM:</span> ${b.pm}</p>
    </div>

    <div class="action-row">
      <button class="action-btn" onclick="openHistory()">üìú History</button>
      <button class="action-btn" id="drawBtn" onclick="openDrawings()">üìê Drawings</button>
      <button class="action-btn" id="plcBtn" onclick="openPLC()">‚ö° PLC-ADD</button>
      <button class="action-btn" onclick="addJob()">‚ûï ADD JOB</button>
    </div>
  </div>`;

  applyButtonState(id);
}

/* ================= INIT ================= */

(async function(){
  await Promise.all([
    preloadDrawings(),
    preloadPLC()
  ]);
  loadData();
})();
</script>

</body>
</html>
