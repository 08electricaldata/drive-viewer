<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transformer Oil Monitoring</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f2f6ff}

/* ===== TOP BAR ===== */
.topbar{
  background:#003f88;color:white;
  padding:12px 15px;
  display:flex;justify-content:space-between;align-items:center
}
.left-btns{display:flex;gap:10px}
.topbar button,.topbar select{
  padding:8px 12px;border:none;border-radius:5px;
  font-weight:bold;cursor:pointer
}
.topbar button{background:white;color:#003f88}
.topbar select{background:white;color:#003f88}

.container{max-width:1500px;margin:20px auto;padding:10px}

/* ===== ALERT PANEL ===== */
.alert-panel{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  margin-bottom:15px;
}

.alert-card{
  flex:1;
  min-width:220px;
  padding:12px;
  border-radius:8px;
  color:white;
  font-weight:bold;
  box-shadow:0 3px 8px rgba(0,0,0,.2);
  animation:pulse 2.5s infinite;
}

.critical{background:#cc0000;}
.warning{background:#ff9900;}
.highest{background:#003f88;}

@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.03)}
  100%{transform:scale(1)}
}

/* ===== SEARCH ===== */
.search-box{
  margin-bottom:15px;
}
.search-box input{
  padding:8px;width:250px;
  border-radius:5px;border:1px solid #ccc
}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
  background:white;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}
th,td{
  padding:8px;
  border:1px solid #ddd;
  font-size:13px;
  text-align:center;
}
th{
  background:#003f88;
  color:white;
  position:sticky;
  top:0;
}
tr:hover{background:#eef5ff;cursor:pointer}
.highlight{background:#ffeaea !important}

/* Wrap style */
.wrap-cell{
  white-space:pre-line;
  text-align:left;
  line-height:1.4;
}

/* Oil level colors */
.low{background:#ff4d4d;color:white}
.medium{background:#ffb84d}
.normal{background:#ffff66}
.good{background:#99e699}
.excellent{background:#33cc33;color:white}

/* ===== CHART BOX ===== */
.topbox{
  margin:20px 0;background:white;padding:15px;
  border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.15)
}

.footer{text-align:center;padding:15px;font-size:14px;color:#555}
</style>
</head>

<body>

<div class="topbar">
  <div class="left-btns">
    <button onclick="history.back()">‚¨Ö Back</button>
    <button onclick="location.href='https://08electricaldata.github.io/'">üè† Home</button>
  </div>
  <div>
    Year:
    <select id="yearSelect"></select>
    Chart:
    <select id="chartType">
      <option value="bar">Bar</option>
      <option value="pie">Pie</option>
    </select>
    <button onclick="exportTable()">üì• Export Excel</button>
  </div>
</div>

<div class="container">

<!-- ALERT PANEL -->
<div class="alert-panel">
  <div class="alert-card critical" id="criticalBox">
    üî¥ Critical Transformers: 0
  </div>
  <div class="alert-card warning" id="warningBox">
    üü° Warning Transformers: 0
  </div>
  <div class="alert-card highest" id="highestBox">
    üìà Highest Consumption: -
  </div>
</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="Search Transformer...">
</div>

<div class="topbox">
  <h3 id="topTitle">Top 10 Transformers Consumption</h3>
  <canvas id="topChart" height="100"></canvas>
</div>

<table id="dataTable">
<thead></thead>
<tbody></tbody>
</table>

</div>

<div class="footer">
¬© 08 Electrical Data | Transformer Oil Monitoring Dashboard
</div>

<script>

const JSON_URL =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/master/transformeroil.json";

let fullData=[], headers=[], chartInstance=null;

async function load(){
  const res=await fetch(JSON_URL);
  const data=await res.json();
  headers=data.headers;
  fullData=data.rows;

  buildYearDropdown();
  buildTable(fullData);
  setDefaultYear();
}

function buildYearDropdown(){
  const years=["2024","2025","2026"];
  const sel=document.getElementById("yearSelect");
  years.forEach(y=>{
    const o=document.createElement("option");
    o.value=y;o.textContent=y;sel.appendChild(o);
  });
  sel.onchange=()=>updateTop10(sel.value);
  document.getElementById("chartType").onchange=
  ()=>updateTop10(sel.value);
}

function setDefaultYear(){
  const lastYear=new Date().getFullYear()-1;
  document.getElementById("yearSelect").value=lastYear;
  updateTop10(lastYear);
}

function formatDate(d){
  if(!d) return "";
  const dt=new Date(d);
  return dt.toLocaleDateString("en-GB").replace(/\//g,"-");
}

function oilClass(val){
  if(val<30) return "low";
  if(val<50) return "medium";
  if(val<70) return "normal";
  if(val<85) return "good";
  return "excellent";
}

function buildTable(data){

  const dropCols=[5,7,9]; // F,H,J removed

  const thead=document.querySelector("#dataTable thead");
  const tbody=document.querySelector("#dataTable tbody");

  thead.innerHTML="";
  tbody.innerHTML="";

  let tr=document.createElement("tr");

  headers.forEach((h,i)=>{
    if(dropCols.includes(i)) return;
    let th=document.createElement("th");
    th.textContent=h;
    tr.appendChild(th);
  });

  thead.appendChild(tr);

  data.forEach(r=>{
    let tr=document.createElement("tr");

    r.forEach((c,i)=>{

      if(dropCols.includes(i)) return;

      let td=document.createElement("td");

      if(i==3){
        td.textContent=formatDate(c);
      }
      else if([11,12,13,14,15,16].includes(i)){
        if(c){
          td.textContent=c.replace(/,\s*/g,",\n");
          td.classList.add("wrap-cell");
        }
      }
      else{
        td.textContent=c;
      }

      if(i==4){
        td.classList.add(oilClass(parseFloat(c)||0));
      }

      tr.appendChild(td);
    });

    tr.onclick=function(){
      const trf=r[2];
      location.href=
      "https://08electricaldata.github.io/drive-viewer/history.html?id=Transformer-"+trf;
    };

    tbody.appendChild(tr);
  });
}

function updateTop10(year){

  let colIndex = year=="2026"?6:
                 year=="2025"?8:10;

  let sorted=fullData
    .map(r=>({
      name:r[2],
      value:parseFloat(r[colIndex])||0,
      oil:parseFloat(r[4])||0
    }))
    .sort((a,b)=>b.value-a.value);

  const top10=sorted.slice(0,10);

  highlightHighest(sorted[0].name);
  drawChart(top10,year);

  const criticalCount = fullData.filter(r =>
    (parseFloat(r[4])||0) < 30
  ).length;

  const warningCount = fullData.filter(r =>{
    let v=parseFloat(r[4])||0;
    return v>=30 && v<50;
  }).length;

  document.getElementById("criticalBox").innerText =
    "üî¥ Critical Transformers: " + criticalCount;

  document.getElementById("warningBox").innerText =
    "üü° Warning Transformers: " + warningCount;

  document.getElementById("highestBox").innerText =
    "üìà Highest Consumption ("+year+"): " +
    sorted[0].name + " (" + sorted[0].value + ")";
}

function highlightHighest(name){
  document.querySelectorAll("tbody tr").forEach(tr=>{
    tr.classList.remove("highlight");
    if(tr.cells[2].textContent==name){
      tr.classList.add("highlight");
    }
  });
}

function drawChart(data,year){

  const type=document.getElementById("chartType").value;

  document.getElementById("topTitle").innerText=
  "Top 10 Transformers Consumption - "+year;

  const ctx=document.getElementById("topChart");

  if(chartInstance) chartInstance.destroy();

  chartInstance=new Chart(ctx,{
    type:type,
    data:{
      labels:data.map(d=>d.name),
      datasets:[{
        data:data.map(d=>d.value),
        backgroundColor:"#003f88"
      }]
    },
    options:{plugins:{legend:{display:type=="pie"}}}
  });
}

document.getElementById("searchInput").onkeyup=function(){
  const term=this.value.toLowerCase();
  const filtered=fullData.filter(r=>
    r[2].toString().toLowerCase().includes(term)
  );
  buildTable(filtered);
};

function exportTable(){
  let csv="";
  headers.forEach((h,i)=>{
    if([5,7,9].includes(i)) return;
    csv+=h+",";
  });
  csv+="\n";

  fullData.forEach(r=>{
    r.forEach((c,i)=>{
      if([5,7,9].includes(i)) return;
      csv+=c+",";
    });
    csv+="\n";
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="TransformerOil.csv";
  link.click();
}

load();
</script>

</body>
</html>
