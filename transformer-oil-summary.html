<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transformer Oil Monitoring</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f2f6ff}

/* TOP BAR */
.topbar{
  background:#003f88;color:white;
  padding:12px 15px;
  display:flex;justify-content:space-between;align-items:center
}
.left-btns{display:flex;gap:10px}
.topbar button{
  padding:8px 12px;border:none;border-radius:5px;
  font-weight:bold;cursor:pointer;background:white;color:#003f88
}

.container{max-width:1500px;margin:20px auto;padding:10px}

/* TABLE */
table{
  width:100%;border-collapse:collapse;
  background:white;box-shadow:0 2px 6px rgba(0,0,0,.15)
}
th,td{
  padding:8px;border:1px solid #ddd;
  text-align:center;font-size:13px
}
th{background:#003f88;color:white}

tr:hover{background:#eef5ff;cursor:pointer}

.wrap-cell{
  white-space:pre-line;
  text-align:left;
}

/* Oil Level Colors */
.low{background:#ff4d4d;color:white}
.medium{background:#ffb84d}
.normal{background:#ffff66}
.good{background:#99e699}
.excellent{background:#33cc33;color:white}

/* POPUP */
.popup{
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.5);
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.popup-content{
  background:white;
  width:80%;
  max-width:800px;
  padding:20px;
  border-radius:10px;
  position:relative;
}
.close-btn{
  position:absolute;
  right:15px;top:10px;
  font-size:18px;
  cursor:pointer;
  font-weight:bold;
}

.footer{text-align:center;padding:15px;color:#555}
</style>
</head>

<body>

<div class="topbar">
  <div class="left-btns">
    <button onclick="history.back()">‚¨Ö Back</button>
    <button onclick="location.href='https://08electricaldata.github.io/'">üè† Home</button>
  </div>
</div>

<div class="container">

<table id="dataTable">
<thead></thead>
<tbody></tbody>
</table>

</div>

<!-- POPUP -->
<div class="popup" id="trendPopup">
  <div class="popup-content">
    <span class="close-btn" onclick="closePopup()">‚úñ</span>
    <canvas id="trendChart" height="100"></canvas>
  </div>
</div>

<div class="footer">
¬© 08 Electrical Data | Transformer Oil Monitoring
</div>

<script>

const JSON_URL =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/master/transformeroil.json";

let fullData=[], headers=[], chartInstance=null;

async function load(){
  const res=await fetch(JSON_URL);
  const data=await res.json();
  headers=data.headers;
  fullData=data.rows;
  buildTable();
}

function formatDate(d){
  if(!d) return "";
  const dt=new Date(d);
  return dt.toLocaleDateString("en-GB").replace(/\//g,"-");
}

function oilClass(val){
  if(val<30) return "low";
  if(val<50) return "medium";
  if(val<70) return "normal";
  if(val<85) return "good";
  return "excellent";
}

function buildTable(){

  const thead=document.querySelector("#dataTable thead");
  const tbody=document.querySelector("#dataTable tbody");

  thead.innerHTML="";
  tbody.innerHTML="";

  // Columns to display
  const displayCols=[0,1,2,3,4,6,8,10,12,14,16,18,20,22];

  let tr=document.createElement("tr");
  displayCols.forEach(i=>{
    let th=document.createElement("th");
    th.textContent=headers[i];
    tr.appendChild(th);
  });
  thead.appendChild(tr);

  fullData.forEach(r=>{
    let tr=document.createElement("tr");

    displayCols.forEach(i=>{
      let td=document.createElement("td");

      if(i==3){
        td.textContent=formatDate(r[i]);
      }
      else if(i==4){
        let val=parseFloat(r[i])||0;
        td.textContent=val+"%";
        td.classList.add(oilClass(val));
      }
      else if([6,8,10,12,14,16,18,20,22].includes(i)){
        let val=parseFloat(r[i])||0;
        td.textContent=val>0?val+" ltrs":"";
      }
      else{
        td.textContent=r[i];
      }

      // Transformer number click ‚Üí popup
      if(i==2){
        td.style.fontWeight="bold";
        td.style.color="#003f88";
        td.onclick=function(e){
          e.stopPropagation();
          showTrend(r);
        };
      }

      tr.appendChild(td);
    });

    // Row click ‚Üí history
    tr.onclick=function(){
      const trf=r[2];
      location.href=
      "https://08electricaldata.github.io/drive-viewer/history.html?id=Transformer-"+trf;
    };

    tbody.appendChild(tr);
  });
}

function showTrend(row){

  document.getElementById("trendPopup").style.display="flex";

  const years=["2018","2019","2020","2021","2022","2023","2024","2025","2026"];
  const values=[
    row[22],row[20],row[18],row[16],
    row[14],row[12],row[10],row[8],row[6]
  ].map(v=>parseFloat(v)||0);

  if(chartInstance) chartInstance.destroy();

  chartInstance=new Chart(
    document.getElementById("trendChart"),
    {
      type:"line",
      data:{
        labels:years,
        datasets:[{
          label:"Yearly Oil Consumption",
          data:values,
          borderColor:"#003f88",
          backgroundColor:"rgba(0,63,136,0.1)",
          fill:true
        }]
      }
    }
  );
}

function closePopup(){
  document.getElementById("trendPopup").style.display="none";
}

load();
</script>

</body>
</html>
