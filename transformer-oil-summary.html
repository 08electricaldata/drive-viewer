<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transformer Oil Monitoring Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f2f6ff}

.topbar{
  background:#003f88;color:white;
  padding:12px 15px;
  display:flex;justify-content:space-between;align-items:center
}
.topbar button{
  padding:8px 12px;border:none;border-radius:5px;
  font-weight:bold;cursor:pointer;background:white;color:#003f88
}

.container{max-width:1500px;margin:20px auto;padding:10px}
/* ===== MAIN HEADER ===== */
.main-header{
  text-align:center;
  margin:20px 0 10px 0;
}
.main-header h1{
  margin:0;
  font-size:26px;
  color:#003f88;
}
.main-header p{
  margin:5px 0 0 0;
  font-size:14px;
  color:#555;
}

.status-panel{
  display:flex;gap:15px;flex-wrap:wrap;margin-bottom:20px
}
.status-card{
  flex:1;min-width:200px;
  padding:15px;border-radius:10px;
  color:white;font-weight:bold;
  text-align:center;
  box-shadow:0 3px 8px rgba(0,0,0,.2);
  animation:pulse 2.5s infinite;
}
.critical{background:#cc0000}
.avg{background:#ff9900}
.medium{background:#ffcc00;color:black}
.safe{background:#33cc33}

@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.05)}
  100%{transform:scale(1)}
}

.chart-box{
  background:white;padding:20px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  margin-bottom:20px;
}

select{
  padding:6px 10px;margin-bottom:10px
}

table{
  width:100%;border-collapse:collapse;
  background:white;box-shadow:0 2px 6px rgba(0,0,0,.15)
}
th,td{
  padding:8px;border:1px solid #ddd;
  text-align:center;font-size:13px
}
th{background:#003f88;color:white}
tr:hover{background:#eef5ff;cursor:pointer}

.low{background:#ff4d4d;color:white}
.mediumLevel{background:#ffb84d}
.normal{background:#ffff66}
.good{background:#99e699}
.excellent{background:#33cc33;color:white}

.popup{
  display:none;position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.5);
  justify-content:center;align-items:center;
}
.popup-content{
  background:white;width:80%;max-width:800px;
  padding:20px;border-radius:10px;
  position:relative;
}
.close-btn{
  position:absolute;right:15px;top:10px;
  font-size:18px;cursor:pointer
}

.footer{text-align:center;padding:15px;color:#555}
</style>
</head>

<body>

<div class="topbar">
  <div>
    <button onclick="history.back()">‚¨Ö Back</button>
    <button onclick="location.href='https://08electricaldata.github.io/'">üè† Home</button>
    <button onclick="openTrafoList()">‚ö° Transformer List</button>
    <button onclick="openTrafoPM()">‚ö° PM Status</button>
  </div>
</div>

<div class="container">

<div class="main-header">
  <h1>TRANSFORMER OIL CONSUMPTION REPORT</h1>
  <p>Designed and Maintained by Rakesh Chandra Sethy</p>
</div>

<div class="status-panel">
  <div class="status-card critical">
    üî¥ Critical (&lt;30%)<br><span id="countCritical">0</span>
  </div>
  <div class="status-card avg">
    üü° 30‚Äì50%<br><span id="countAvg">0</span>
  </div>
  <div class="status-card medium">
    üü† 50‚Äì70%<br><span id="countMedium">0</span>
  </div>
  <div class="status-card safe">
    üü¢ Safe (&gt;70%)<br><span id="countSafe">0</span>
  </div>
</div>

<div class="chart-box">
  <label>Select Year:</label>
  <select id="yearSelect"></select>
  <canvas id="mainChart" height="100"></canvas>
</div>

<table id="dataTable">
<thead></thead>
<tbody></tbody>
</table>

</div>

<div class="popup" id="trendPopup">
  <div class="popup-content">
    <span class="close-btn" onclick="closePopup()">‚úñ</span>
    <canvas id="trendChart" height="100"></canvas>
  </div>
</div>

<div class="footer">
¬© 08 Electrical Data | Transformer Oil Dashboard
</div>

<script>

const JSON_URL =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/master/transformeroil.json";

/* ‚úÖ NEW NAV FUNCTIONS */
function openTrafoList(){
  location.href="https://08electricaldata.github.io/drive-viewer/trafolist.html";
}
function openTrafoPM(){
  location.href="https://08electricaldata.github.io/drive-viewer/trafopm.html";
}

let fullData=[], headers=[], mainChart=null, trendChart=null;

async function load(){
  const res=await fetch(JSON_URL);
  const data=await res.json();
  headers=data.headers;
  fullData=data.rows;

  buildYearDropdown();
  buildTable();
  updateStatusCounts();
}

function buildYearDropdown(){
  const sel=document.getElementById("yearSelect");
  for(let y=2018;y<=2026;y++){
    let o=document.createElement("option");
    o.value=y;o.textContent=y;
    sel.appendChild(o);
  }
  sel.value=new Date().getFullYear();
  sel.onchange=()=>updateMainChart(sel.value);
  updateMainChart(sel.value);
}

function updateMainChart(year){

  const colIndexMap={
    2026:6,2025:8,2024:10,
    2023:12,2022:14,2021:16,
    2020:18,2019:20,2018:22
  };

  const col=colIndexMap[year];

  let sorted=fullData
    .map(r=>({
      name:r[2],
      value:parseFloat(r[col])||0
    }))
    .sort((a,b)=>b.value-a.value)
    .slice(0,10);

  if(mainChart) mainChart.destroy();

  mainChart=new Chart(
    document.getElementById("mainChart"),
    {
      type:"bar",
      data:{
        labels:sorted.map(d=>d.name),
        datasets:[{
          label:"Top 10 Oil Consumption "+year,
          data:sorted.map(d=>d.value),
          backgroundColor:"#003f88"
        }]
      }
    }
  );
}

function updateStatusCounts(){

  let c=0,a=0,m=0,s=0;

  fullData.forEach(r=>{
    let v=parseFloat(r[4])||0;
    if(v<30)c++;
    else if(v<50)a++;
    else if(v<70)m++;
    else s++;
  });

  animateValue("countCritical",c);
  animateValue("countAvg",a);
  animateValue("countMedium",m);
  animateValue("countSafe",s);
}

function animateValue(id,end){
  let start=0;
  let duration=800;
  let range=end-start;
  let stepTime=Math.abs(Math.floor(duration/(range||1)));
  let obj=document.getElementById(id);
  let timer=setInterval(()=>{
    start++;
    obj.textContent=start;
    if(start>=end) clearInterval(timer);
  },stepTime||50);
}

function buildTable(){

  const displayCols=[0,1,2,3,4,6,8,10,12,14,16,18,20,22];

  const thead=document.querySelector("#dataTable thead");
  const tbody=document.querySelector("#dataTable tbody");

  let tr=document.createElement("tr");
  displayCols.forEach(i=>{
    let th=document.createElement("th");
    th.textContent=headers[i];
    tr.appendChild(th);
  });
  thead.appendChild(tr);

  fullData.forEach(r=>{
    let tr=document.createElement("tr");

    displayCols.forEach(i=>{
      let td=document.createElement("td");

      if(i==3){
        if(r[i]){
          const dt=new Date(r[i]);
          const options={day:'2-digit',month:'short',year:'numeric'};
          td.textContent=dt.toLocaleDateString('en-GB',options).replace(/ /g,'-');
        } else td.textContent="";
      }
      else if(i==4){
        let v=parseFloat(r[i])||0;
        td.textContent=v+"%";
        if(v<30)td.classList.add("low");
        else if(v<50)td.classList.add("mediumLevel");
        else if(v<70)td.classList.add("normal");
        else td.classList.add("excellent");
      }
      else if([6,8,10,12,14,16,18,20,22].includes(i)){
        let v=parseFloat(r[i])||0;
        td.textContent=v>0?v+" ltrs":"";
      }
      else{
        td.textContent=r[i];
      }

      if(i==2){
        td.style.fontWeight="bold";
        td.style.color="#003f88";
        td.onclick=function(e){
          e.stopPropagation();
          showTrend(r);
        };
      }

      tr.appendChild(td);
    });

    tr.onclick=function(){
      location.href=
      "https://08electricaldata.github.io/drive-viewer/history.html?id=Transformer-"+r[2];
    };

    tbody.appendChild(tr);
  });
}

function showTrend(row){

  document.getElementById("trendPopup").style.display="flex";

  const years=["2018","2019","2020","2021","2022","2023","2024","2025","2026"];
  const values=[
    row[22],row[20],row[18],row[16],
    row[14],row[12],row[10],row[8],row[6]
  ].map(v=>parseFloat(v)||0);

  if(trendChart) trendChart.destroy();

  trendChart=new Chart(
    document.getElementById("trendChart"),
    {
      type:"line",
      data:{
        labels:years,
        datasets:[{
          label:"Yearly Oil Consumption",
          data:values,
          borderColor:"#003f88",
          backgroundColor:"rgba(0,63,136,0.1)",
          fill:true
        }]
      }
    }
  );
}

function closePopup(){
  document.getElementById("trendPopup").style.display="none";
}

load();
</script>

</body>
</html>
