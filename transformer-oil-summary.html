<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transformer Oil Monitoring</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f2f6ff}

/* TOP BAR */
.topbar{
  background:#003f88;color:white;
  padding:12px 15px;
  display:flex;justify-content:space-between;align-items:center
}
.left-btns{display:flex;gap:10px}
.topbar button,.topbar select{
  padding:8px 12px;border:none;border-radius:5px;
  font-weight:bold;cursor:pointer
}
.topbar button{background:white;color:#003f88}
.topbar select{background:white;color:#003f88}

.container{max-width:1400px;margin:20px auto;padding:10px}

/* SEARCH */
.search-box{
  margin-bottom:15px;
  display:flex;justify-content:space-between;gap:10px
}
.search-box input{
  padding:8px;width:250px;border-radius:5px;border:1px solid #ccc
}

/* TABLE */
table{
  width:100%;border-collapse:collapse;
  background:white;box-shadow:0 2px 6px rgba(0,0,0,.15);
}
th,td{
  padding:8px;text-align:center;
  border:1px solid #ddd;font-size:13px;
  white-space:nowrap
}
th{background:#003f88;color:white;position:sticky;top:0}

tr:hover{background:#eef5ff;cursor:pointer}
.highlight{background:#ffeaea !important}
.blink{animation:blink 1s infinite}
@keyframes blink{50%{background:#ffcccc}}

.low{background:#ff4d4d;color:white}
.medium{background:#ffb84d}
.normal{background:#ffff66}
.good{background:#99e699}
.excellent{background:#33cc33;color:white}

/* TOP BOX */
.topbox{
  margin:20px 0;background:white;padding:15px;
  border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.15)
}

.footer{text-align:center;padding:15px;font-size:14px;color:#555}
</style>
</head>

<body>

<div class="topbar">
  <div class="left-btns">
    <button onclick="history.back()">‚¨Ö Back</button>
    <button onclick="location.href='https://08electricaldata.github.io/'">üè† Home</button>
  </div>
  <div>
    Year:
    <select id="yearSelect"></select>
    Chart:
    <select id="chartType">
      <option value="bar">Bar</option>
      <option value="pie">Pie</option>
    </select>
    <button onclick="exportTable()">üì• Export Excel</button>
  </div>
</div>

<div class="container">

<div class="search-box">
  <input type="text" id="searchInput" placeholder="Search Transformer...">
</div>

<div class="topbox">
  <h3 id="topTitle">Top 10 Transformers Consumption</h3>
  <canvas id="topChart" height="100"></canvas>
</div>

<table id="dataTable">
<thead></thead>
<tbody></tbody>
</table>

</div>

<div class="footer">
¬© 08 Electrical Data | Advanced Transformer Oil Monitoring
</div>

<script>

const JSON_URL =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/master/transformeroil.json";

let fullData=[], headers=[], chartInstance=null;

async function load(){
  const res=await fetch(JSON_URL);
  const data=await res.json();
  headers=data.headers;
  fullData=data.rows;

  buildYearDropdown();
  buildTable(fullData);
  setDefaultYear();
}

function buildYearDropdown(){
  const years=["2024","2025","2026"];
  const sel=document.getElementById("yearSelect");
  years.forEach(y=>{
    const o=document.createElement("option");
    o.value=y;o.textContent=y;sel.appendChild(o);
  });
  sel.onchange=()=>updateTop10(sel.value);
  document.getElementById("chartType").onchange=
  ()=>updateTop10(sel.value);
}

function setDefaultYear(){
  const lastYear=new Date().getFullYear()-1;
  document.getElementById("yearSelect").value=lastYear;
  updateTop10(lastYear);
}

function formatDate(d){
  if(!d) return "";
  const dt=new Date(d);
  return dt.toLocaleDateString("en-GB").replace(/\//g,"-");
}

function oilClass(val){
  if(val<30) return "low";
  if(val<50) return "medium";
  if(val<70) return "normal";
  if(val<85) return "good";
  return "excellent";
}

function buildTable(data){
  const thead=document.querySelector("#dataTable thead");
  const tbody=document.querySelector("#dataTable tbody");
  thead.innerHTML="";tbody.innerHTML="";

  let tr=document.createElement("tr");
  headers.forEach(h=>{
    let th=document.createElement("th");
    th.textContent=h;
    tr.appendChild(th);
  });
  thead.appendChild(tr);

  data.forEach(r=>{
    let tr=document.createElement("tr");

    r.forEach((c,i)=>{
      let td=document.createElement("td");

      if(i==3) td.textContent=formatDate(c);
      else td.textContent=c;

      if(i==4){ // Oil level column
        td.classList.add(oilClass(parseFloat(c)||0));
      }

      tr.appendChild(td);
    });

    tr.onclick=function(){
      showTrend(r);
      const trf=r[2];
      location.href=
      "https://08electricaldata.github.io/drive-viewer/history.html?id=Transformer-"+trf;
    };

    tbody.appendChild(tr);
  });
}

function updateTop10(year){

  let colIndex = year=="2026"?6:
                 year=="2025"?8:10;

  let sorted=fullData
    .map(r=>({
      name:r[2],
      value:parseFloat(r[colIndex])||0
    }))
    .sort((a,b)=>b.value-a.value);

  const top10=sorted.slice(0,10);

  highlightHighest(sorted[0].name);

  if(sorted[0].value>100){
    document.querySelector("table").classList.add("blink");
  }else{
    document.querySelector("table").classList.remove("blink");
  }

  drawChart(top10,year);
}

function highlightHighest(name){
  document.querySelectorAll("tbody tr").forEach(tr=>{
    tr.classList.remove("highlight");
    if(tr.cells[2].textContent==name){
      tr.classList.add("highlight");
    }
  });
}

function drawChart(data,year){

  const type=document.getElementById("chartType").value;

  document.getElementById("topTitle").innerText=
  "Top 10 Transformers Consumption - "+year;

  const ctx=document.getElementById("topChart");

  if(chartInstance) chartInstance.destroy();

  chartInstance=new Chart(ctx,{
    type:type,
    data:{
      labels:data.map(d=>d.name),
      datasets:[{
        data:data.map(d=>d.value),
        backgroundColor:"#003f88"
      }]
    },
    options:{plugins:{legend:{display:type=="pie"}}}
  });
}

function showTrend(row){
  // simple yearly trend using columns
  const years=["2018","2019","2020","2021","2022","2023","2024","2025","2026"];
  const values=[row[16],row[15],row[14],row[13],row[12],row[11],row[10],row[8],row[6]];

  if(chartInstance) chartInstance.destroy();

  chartInstance=new Chart(
    document.getElementById("topChart"),
    {
      type:"line",
      data:{
        labels:years,
        datasets:[{
          label:"Trend - "+row[2],
          data:values.map(v=>parseFloat(v)||0),
          borderColor:"#003f88",
          fill:false
        }]
      }
    }
  );
}

document.getElementById("searchInput").onkeyup=function(){
  const term=this.value.toLowerCase();
  const filtered=fullData.filter(r=>
    r[2].toString().toLowerCase().includes(term)
  );
  buildTable(filtered);
};

function exportTable(){
  let csv="";
  headers.forEach(h=>csv+=h+",");
  csv+="\n";
  fullData.forEach(r=>{
    csv+=r.join(",")+"\n";
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="TransformerOil.csv";
  link.click();
}

load();
</script>

</body>
</html>
