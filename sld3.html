<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HT Board Professional SLD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;margin:0;background:#f2f6ff}

.header-bar{
  position:sticky;top:0;z-index:1000;
  background:#003f88;color:#fff;
  display:flex;align-items:center;gap:10px;
  padding:12px;
}
.header-bar button{
  background:#fff;color:#003f88;border:none;
  border-radius:6px;padding:8px 12px;
  font-size:16px;cursor:pointer;
}
.header-title{flex:1;text-align:center;font-size:22px;font-weight:700}

.container{padding:12px}
.card{
  background:#fff;border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
  padding:12px;
}

#columnTable{
  width:100%;
  border-collapse:collapse;
  margin-bottom:15px;
}
#columnTable td{
  border:1px solid #000;
  padding:6px;
  text-align:center;
  font-weight:600;
  font-size:14px;
}

#wrap{
  overflow:auto;
  border:1px solid #ccc;
  background:#fff;
  height:65vh;
}
.bus{stroke:#000;stroke-width:4}
.info{font-weight:bold;color:#003f88;margin-bottom:8px}
</style>
</head>

<body>

<div class="header-bar">
  <button onclick="goHome()">üè† Home</button>
  <button onclick="goBack()">‚¨Ö Back</button>
  <div class="header-title" id="title">HT BOARD SLD</div>
</div>

<div class="container">
  <div class="card">

    <div id="boardInfo" class="info">Loading...</div>

    <!-- üî• FIXED TABLE -->
    <table id="columnTable"></table>

    <div id="wrap">
      <svg id="sldCanvas" viewBox="0 0 1400 620"></svg>
    </div>

  </div>
</div>

<script>

const JSON_URL =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/sld/boards_sld.json";

function goHome(){location.href="https://08electricaldata.github.io/"}
function goBack(){history.back()}
function getParam(n){return new URL(location.href).searchParams.get(n)}

const columnTable=document.getElementById("columnTable");
const boardInfoEl=document.getElementById("boardInfo");
const titleEl=document.getElementById("title");

/* ================= TABLE BUILDER (FIXED) ================= */

function buildColumnTable(board){

  columnTable.innerHTML="";

  // Combine ALL devices
  const allDevices=[
    ...(board.incomers||[]),
    ...(board.outgoings||[]),
    ...(board.busCouplers||[]),
    ...(board.dgIncomers||[]),
    ...(board.emergencyIncomers||[])
  ];

  if(!allDevices.length) return;

  // üî• FIX: Correct max position detection
  let maxPos = 0;
  allDevices.forEach(d=>{
    if(d.position && d.position > maxPos){
      maxPos = d.position;
    }
  });

  if(maxPos === 0) return;

  const row1=document.createElement("tr"); // COLUMN F
  const row2=document.createElement("tr"); // COLUMN D
  const row3=document.createElement("tr"); // COLUMN E

  for(let i=1;i<=maxPos;i++){

    const device = allDevices.find(d => d.position === i);

    const td1=document.createElement("td");
    const td2=document.createElement("td");
    const td3=document.createElement("td");

    if(device){
      // ‚úÖ FIRST ROW ‚Üí COLUMN F VALUE
      td1.innerText = device.source || "";

      // ‚úÖ SECOND ROW ‚Üí COLUMN D VALUE
      td2.innerText = device.breakerId || "";

      // ‚úÖ THIRD ROW ‚Üí COLUMN E VALUE
      td3.innerText = device.breakerType || "";
    }

    row1.appendChild(td1);
    row2.appendChild(td2);
    row3.appendChild(td3);
  }

  columnTable.appendChild(row1);
  columnTable.appendChild(row2);
  columnTable.appendChild(row3);
}

/* ================= LOAD ================= */

async function loadSLD(){
  try{
    const boardId=getParam("id");
    if(!boardId){
      boardInfoEl.innerText="‚ùå Board id missing";
      return;
    }

    titleEl.innerText=boardId+" ‚Äî Professional SLD";

    const res=await fetch(JSON_URL);
    const data=await res.json();
    const board=data.boards?.[boardId];

    if(!board){
      boardInfoEl.innerText="‚ùå Board not found";
      return;
    }

    boardInfoEl.innerText="Incomers: "+board.topology.totalIncomers;

    // üî• BUILD FIXED TABLE
    buildColumnTable(board);

  }catch(e){
    console.error(e);
    boardInfoEl.innerText="‚ùå Drawing error";
  }
}

loadSLD();

</script>
</body>
</html>
