<script>
// ================= CONFIG =================
const JSON_URL =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/sld/boards_sld.json";

// NAV
function goHome(){location.href="https://08electricaldata.github.io/"}
function goBack(){history.back()}
function getParam(n){return new URL(location.href).searchParams.get(n)}

const svg=document.getElementById("sldCanvas");
function clearSVG(){svg.innerHTML=""}

// ---------- primitives ----------
function line(x1,y1,x2,y2,cls="bus"){
  const e=document.createElementNS("http://www.w3.org/2000/svg","line");
  e.setAttribute("x1",x1);
  e.setAttribute("y1",y1);
  e.setAttribute("x2",x2);
  e.setAttribute("y2",y2);
  e.setAttribute("class",cls);
  svg.appendChild(e);
}

function text(x,y,str,anchor="middle",cls="label"){
  const t=document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x",x);
  t.setAttribute("y",y);
  t.setAttribute("text-anchor",anchor);
  t.setAttribute("class",cls);
  t.textContent=str;
  svg.appendChild(t);
}

// ⭐⭐⭐ SAFE WRAP (NO WHITE SCREEN) ⭐⭐⭐
function wrappedText(x,y,str,maxCharsPerLine=14){
  const words=String(str).split(" ");
  const lineHeight=18;

  let lines=[];
  let current="";

  words.forEach(w=>{
    if((current+w).length>maxCharsPerLine){
      lines.push(current.trim());
      current=w+" ";
    }else{
      current+=w+" ";
    }
  });
  lines.push(current.trim());

  const textEl=document.createElementNS("http://www.w3.org/2000/svg","text");
  textEl.setAttribute("x",x);
  textEl.setAttribute("y",y);
  textEl.setAttribute("text-anchor","middle");
  textEl.setAttribute("class","label");

  lines.forEach((ln,i)=>{
    const tspan=document.createElementNS("http://www.w3.org/2000/svg","tspan");
    tspan.setAttribute("x",x);
    tspan.setAttribute("dy",i===0?0:lineHeight);
    tspan.textContent=ln;
    textEl.appendChild(tspan);
  });

  svg.appendChild(textEl);
}

// ---------- board title ----------
function drawBoardTitle(name){
  const t=document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x",700);
  t.setAttribute("y",40);
  t.setAttribute("class","board-title");
  t.textContent=name;
  svg.appendChild(t);
}

// ---------- transformer ----------
function transformer(x,y,name){
  const c1=document.createElementNS("http://www.w3.org/2000/svg","circle");
  c1.setAttribute("cx",x-12);
  c1.setAttribute("cy",y);
  c1.setAttribute("r",10);
  c1.setAttribute("stroke","#000");
  c1.setAttribute("fill","none");

  const c2=document.createElementNS("http://www.w3.org/2000/svg","circle");
  c2.setAttribute("cx",x+12);
  c2.setAttribute("cy",y);
  c2.setAttribute("r",10);
  c2.setAttribute("stroke","#000");
  c2.setAttribute("fill","none");

  svg.appendChild(c1);
  svg.appendChild(c2);
  text(x,y-18,name);
}

// ---------- breaker ----------
function breaker(x,y,label,side=null,isCoupler=false){
  const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
  r.setAttribute("x",x-18);
  r.setAttribute("y",y-12);
  r.setAttribute("width",36);
  r.setAttribute("height",24);
  r.setAttribute("fill","#fff");
  r.setAttribute("stroke","#000");
  r.setAttribute("stroke-width","2");
  svg.appendChild(r);

  text(x,y+5,"CB","middle","cbtext");

  if(isCoupler){
    text(x,y-24,label);
  }else if(side==="left"){
    text(x-140,y+5,label,"end");
  }else if(side==="right"){
    text(x+140,y+5,label,"start");
  }
}

// ---------- arrow ----------
function arrowDown(x,y){
  line(x,y,x,y+24,"bus");
  const p=document.createElementNS("http://www.w3.org/2000/svg","polygon");
  p.setAttribute("points",`${x-6},${y+24} ${x+6},${y+24} ${x},${y+36}`);
  p.setAttribute("fill","#000");
  svg.appendChild(p);
}

// ================= LOAD =================
async function loadSLD(){
  try{
    const boardId=getParam("id");
    if(!boardId){boardInfo.innerText="❌ Board id missing";return;}

    title.innerText=boardId+" — Professional SLD";

    const res=await fetch(JSON_URL);
    const data=await res.json();
    const board=data.boards?.[boardId];

    if(!board){boardInfo.innerText="❌ Board not found";return;}

    boardInfo.innerText=`Incomers: ${board.topology.totalIncomers}`;
    draw(board,boardId);
  }catch(err){
    console.error(err);
    boardInfo.innerText="❌ Drawing error — check console";
  }
}

// ================= DRAW =================
function draw(board,boardId){
  clearSVG();

  const W=1400;
  const BUS_Y=280;
  const GAP=120;
  const mid=W/2;

  drawBoardTitle(boardId);

  // BUS A & B
  line(100,BUS_Y,mid-GAP/2,BUS_Y,"bus");
  line(mid+GAP/2,BUS_Y,W-100,BUS_Y,"bus");

  // COUPLER
  if(board.busCouplers?.length){
    breaker(mid,BUS_Y,"BUS COUPLER",null,true);
  }

  // INCOMERS
  const incomers=[
    ...board.incomers,
    ...board.dgIncomers,
    ...board.emergencyIncomers
  ];

  const spacing=W/(incomers.length+1);

  incomers.forEach((inc,i)=>{
    const x=spacing*(i+1);
    transformer(x,120,inc.source);
    line(x,140,x,BUS_Y-30,"power-line");
    const side=(i===0)?"left":"right";
    breaker(x,BUS_Y-40,inc.breakerId,side,false);
  });

  // POSITION-BASED OUTGOINGS
  let maxPos=0;
  [...board.incomers,...board.outgoings,...(board.busCouplers||[])]
    .forEach(r=>{ if(r.position>maxPos) maxPos=r.position; });

  const leftMargin=120;
  const rightMargin=W-120;
  const usableWidth=rightMargin-leftMargin;

  function posToX(pos){
    return leftMargin+(usableWidth*(pos-1)/(maxPos-1));
  }

  board.outgoings.forEach(o=>{
    const x=posToX(o.position);

    line(x,BUS_Y+6,x,BUS_Y+46,"bus");
    breaker(x,BUS_Y+66,null);
    arrowDown(x,BUS_Y+82);

    wrappedText(x,BUS_Y+165,o.breakerId,16);
  });
}

loadSLD();
</script>
