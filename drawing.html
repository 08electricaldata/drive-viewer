<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Equipment Drawings</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;margin:0;background:#f2f6ff}

/* HEADER */
.header{
  background:#003f88;color:white;
  padding:15px;text-align:center
}

.container{padding:20px}

.card{
  background:white;padding:20px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.15)
}

/* GROUP TITLE */
.group-title{
  margin-top:25px;
  font-weight:bold;
  color:#003f88;
  font-size:18px;
  border-bottom:2px solid #003f88;
  padding-bottom:5px
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:18px;
  margin-top:15px
}

/* TILE */
.tile{
  background:#f8fbff;
  padding:12px;
  border-radius:10px;
  box-shadow:0 2px 5px rgba(0,0,0,.1);
  cursor:pointer;
  text-align:center;
  transition:.2s
}
.tile:hover{transform:scale(1.03)}

.tile img{
  width:100%;
  height:150px;
  object-fit:cover;
  border-radius:8px;
  margin-bottom:8px
}

.tile h4{
  margin:5px 0;
  font-size:14px;
  color:#003f88
}

.tile small{
  font-size:12px;color:#666
}

/* VIEWER */
.viewer{
  margin-top:30px;
  height:650px;
  border:1px solid #ccc;
  border-radius:10px;
  overflow:hidden;
  display:none;
  position:relative
}
.viewer iframe{
  width:100%;
  height:100%;
  border:none
}

/* CONTROLS */
.viewer-controls{
  margin-top:10px;
  text-align:right
}
.viewer-controls button{
  padding:8px 14px;
  border:none;
  background:#003f88;
  color:white;
  border-radius:6px;
  cursor:pointer;
  margin-left:8px
}

/* FULLSCREEN */
.viewer.fullscreen{
  position:fixed;
  top:0;left:0;
  width:100%;
  height:100%;
  z-index:9999;
  background:white;
  border-radius:0
}

.no-data{
  color:red;
  text-align:center;
  font-weight:bold
}

@media(max-width:768px){
  .viewer{height:450px}
}
</style>
</head>

<body>

<div class="header">
  <h2>Equipment Drawings</h2>
</div>

<div class="container">
  <div id="content">Loading drawings...</div>
</div>

<script>
const JSON_URL =
"https://raw.githubusercontent.com/08electricaldata/08electricaldata-json/main/drawings/drawings.json";

function normalize(v){
  return String(v||"").toUpperCase().trim();
}

/* ===== Extract Drive File ID ===== */
function getFileId(link){
  const match = link.match(/[-\w]{25,}/);
  return match ? match[0] : null;
}

/* ===== Proper Google Drive Embed ===== */
function convertToEmbed(link){
  const fileId = getFileId(link);
  if(!fileId) return link;

  // BEST working embed method
  return "https://drive.google.com/file/d/"+fileId+"/preview";
}

/* ===== Thumbnail ===== */
function convertToThumbnail(link){
  const fileId = getFileId(link);
  if(!fileId) return "";
  return "https://drive.google.com/thumbnail?id="+fileId;
}

/* ===== Download Counter ===== */
function incrementDownload(id,index){
  const key="draw_"+id+"_"+index;
  let count=localStorage.getItem(key);
  count = count ? Number(count)+1 : 1;
  localStorage.setItem(key,count);
  return count;
}
function getDownload(id,index){
  return localStorage.getItem("draw_"+id+"_"+index)||0;
}

/* ===== LOAD PAGE ===== */
async function load(){
  const id = normalize(new URLSearchParams(location.search).get("id"));
  if(!id) return;

  const j = await (await fetch(JSON_URL)).json();
  const item = j.rows.find(r=>normalize(r.id)===id);

  if(!item){
    content.innerHTML =
      "<div class='card no-data'>No Drawings Available</div>";
    return;
  }

  let html=`<div class="card">
              <h3>${id}</h3>`;

  Object.keys(item).forEach(group=>{
    if(group==="id") return;
    if(!Array.isArray(item[group])) return;

    html+=`<div class="group-title">${group.toUpperCase()}</div>
           <div class="grid">`;

    item[group].forEach((link,i)=>{
      if(!link) return;

      const thumb = convertToThumbnail(link);
      const count = getDownload(id,i);

      html+=`
        <div class="tile"
             onclick="openDrawing('${id}',${i},'${link}')">
          <img src="${thumb}"
               onerror="this.src='https://via.placeholder.com/300x200?text=PDF'">
          <h4>Drawing ${i+1}</h4>
          <small id="count_${i}">Downloads: ${count}</small>
        </div>`;
    });

    html+=`</div>`;
  });

  html+=`
        <div class="viewer" id="viewerBox">
          <iframe id="pdfFrame"></iframe>
        </div>

        <div class="viewer-controls">
          <button onclick="toggleFullScreen()">ðŸ“± Full Screen</button>
          <button onclick="printDrawing()">ðŸ–¨ Print</button>
        </div>
        </div>`;

  content.innerHTML=html;
}

/* ===== OPEN DRAWING ===== */
function openDrawing(id,index,link){

  const embed = convertToEmbed(link);

  const frame = document.getElementById("pdfFrame");
  const viewer = document.getElementById("viewerBox");

  frame.src = embed;
  viewer.style.display="block";

  const newCount = incrementDownload(id,index);
  document.getElementById("count_"+index).innerText =
    "Downloads: "+newCount;
}

/* ===== PRINT ===== */
function printDrawing(){
  const frame=document.getElementById("pdfFrame");
  if(frame && frame.contentWindow){
    frame.contentWindow.print();
  }
}

/* ===== FULL SCREEN ===== */
function toggleFullScreen(){
  const viewer=document.getElementById("viewerBox");
  viewer.classList.toggle("fullscreen");
}

load();
</script>

</body>
</html>
